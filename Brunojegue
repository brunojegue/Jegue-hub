--[[
    Khalexis Hub - Atualizado e Corrigido
    - Categoria Planta Vs Brainrot Scripts: 5 scripts
    - Botão "K" corrigido (sem duplicação)
    - Hub abre apenas uma vez
    - Toggle sempre visível e arrastável
--]]

local function applyRoundedCorners(guiObject, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius or 8)
    corner.Parent = guiObject
end

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KhalexisHub"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

-- Paletas de Cores
local themes = {
    normal = {main_bg = Color3.fromRGB(30, 30, 30), category_bg = Color3.fromRGB(50, 50, 50), title_bar = Color3.fromRGB(45, 45, 45), script_frame_bg = Color3.fromRGB(30, 30, 30), transparency = 0},
    preto = {main_bg = Color3.fromRGB(10, 10, 10), category_bg = Color3.fromRGB(25, 25, 25), title_bar = Color3.fromRGB(20, 20, 20), script_frame_bg = Color3.fromRGB(10, 10, 10), transparency = 0},
    laranja = {main_bg = Color3.fromRGB(255, 140, 0), category_bg = Color3.fromRGB(40, 40, 40), title_bar = Color3.fromRGB(30, 30, 30), script_frame_bg = Color3.fromRGB(50, 50, 50), transparency = 0},
    roxo = {main_bg = Color3.fromRGB(138, 43, 226), category_bg = Color3.fromRGB(40, 40, 40), title_bar = Color3.fromRGB(30, 30, 30), script_frame_bg = Color3.fromRGB(50, 50, 50), transparency = 0},
    transparente = {main_bg = Color3.fromRGB(30, 30, 30), category_bg = Color3.fromRGB(50, 50, 50), title_bar = Color3.fromRGB(45, 45, 45), script_frame_bg = Color3.fromRGB(30, 30, 30), transparency = 0.4}
}

local COLOR_BLACK = themes.normal.main_bg
local COLOR_CATEGORY_BG = themes.normal.category_bg
local COLOR_CATEGORY_BTN = Color3.fromRGB(90, 90, 90)
local COLOR_SCRIPT_BTN = Color3.fromRGB(70, 70, 70)
local COLOR_TITLEBAR = themes.normal.title_bar
local COLOR_TEXT = Color3.fromRGB(220, 220, 220)
local COLOR_ERROR = Color3.fromRGB(255, 85, 85)
local COLOR_FOOTER_TEXT = Color3.fromRGB(170, 170, 170)

local userId = player.UserId
local userName = player.Name
local KeyFrame, MainFrameContainer
local LoadingScreen, StopLoadingAnim
local HubOpen = false
local ToggleButton
local ErrorLabel
local HasShownWelcome = false

local StorageKeyFileName = "KhalexisHubKey.txt"
local validKeys = {khalexispremium100 = true, khalexislindodms10 = true}

local function saveKeyLocally(key) pcall(function() if writefile then writefile(StorageKeyFileName, key) elseif write_file then write_file(StorageKeyFileName, key) end end) end
local function loadKeyLocally() local s,c = pcall(function() if readfile then return readfile(StorageKeyFileName) elseif read_file then return read_file(StorageKeyFileName) end end); if s and c then return c:lower() end; return nil end
local function removeLocalKey() pcall(function() if delfile then delfile(StorageKeyFileName)elseif deletefile then deletefile(StorageKeyFileName) end end) end

local function showAutoMessage(msg) 
    local m = Instance.new("Frame"); m.Size=UDim2.new(0,320,0,45); m.Position=UDim2.new(1,-330,1,-55); m.BackgroundColor3=COLOR_BLACK; m.BorderSizePixel=0; m.Parent=ScreenGui; applyRoundedCorners(m,10); 
    local l=Instance.new("TextLabel"); l.Size=UDim2.new(1,-20,1,-10); l.Position=UDim2.new(0,10,0,5); l.BackgroundTransparency=1; l.TextColor3=COLOR_TEXT; l.Font=Enum.Font.GothamBold; l.TextSize=16; l.Text=msg; l.TextWrapped=true; l.TextXAlignment=Enum.TextXAlignment.Left; l.TextYAlignment=Enum.TextYAlignment.Center; l.Parent=m; 
    spawn(function() wait(4); if m and m.Parent then m:Destroy() end end) 
end
local function showError(msg) if ErrorLabel then ErrorLabel.Text=msg; spawn(function() wait(2); if ErrorLabel and ErrorLabel.Parent then ErrorLabel.Text="" end end) end end
local function copyToClipboard(text) return pcall(function() if setclipboard then setclipboard(text)elseif toclipboard then toclipboard(text) else error("Clipboard function not supported.") end end) end

local function closeHubWithAnimation(container)
    if not (container and container.Parent) then return end
    local uiScaler = container:FindFirstChildOfClass("UIScale")
    if not uiScaler then container:Destroy(); return end
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
    local goal = { Scale = 0 }
    local tween = TweenService:Create(uiScaler, tweenInfo, goal)
    tween:Play()
    tween.Completed:Wait()
    if container and container.Parent then container:Destroy() end
    MainFrameContainer = nil
    HubOpen = false
    if ToggleButton then ToggleButton.Visible = true end
end

local function showLoadingScreen()
    local frame = Instance.new("Frame")
    frame.Name = "LoadingFrame"
    frame.Size = UDim2.new(0, 300, 0, 120)
    frame.Position = UDim2.new(0.5, -150, 0.5, -60)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = ScreenGui
    applyRoundedCorners(frame, 16)
    local border = Instance.new("UIStroke")
    border.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    border.Color = Color3.fromRGB(0, 0, 0)
    border.Thickness = 2
    border.Parent = frame
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 30)
    label.Position = UDim2.new(0, 0, 0.3, -15)
    label.BackgroundTransparency = 1
    label.Text = "Carregando..."
    label.TextColor3 = COLOR_TEXT
    label.Font = Enum.Font.GothamBold
    label.TextSize = 20
    label.Parent = frame
    local spinner = Instance.new("Frame")
    spinner.Size = UDim2.new(0, 50, 0, 50)
    spinner.Position = UDim2.new(0.5, -25, 0, 60)
    spinner.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    spinner.BorderSizePixel = 0
    applyRoundedCorners(spinner, 25)
    spinner.Parent = frame
    local orangeBall = Instance.new("Frame")
    orangeBall.Size = UDim2.new(0, 50, 0, 50)
    orangeBall.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
    applyRoundedCorners(orangeBall, 25)
    orangeBall.Parent = spinner
    local whiteBall = Instance.new("Frame")
    whiteBall.Size = UDim2.new(0, 20, 0, 20)
    whiteBall.Position = UDim2.new(0.5, -10, 0.5, -10)
    whiteBall.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    applyRoundedCorners(whiteBall, 10)
    whiteBall.Parent = orangeBall
    local angle = 0
    local connection
    connection = RunService.RenderStepped:Connect(function()
        angle = (angle + 6) % 360
        orangeBall.Rotation = angle
        whiteBall.Rotation = -angle * 2
    end)
    return frame, function()
        if connection then connection:Disconnect(); connection = nil end
    end
end

local function applyTheme(themeName)
    local palette = themes[themeName]
    if not palette or not MainFrameContainer then return end
    local MainFrame = MainFrameContainer:FindFirstChild("MainFrame")
    if not MainFrame then return end
    local titleBar = MainFrame:FindFirstChild("TitleBar")
    local categoryFrame = MainFrame:FindFirstChild("CategoryFrame")
    local scriptFrame = MainFrame:FindFirstChild("ScriptFrame")
    local footerBackground = MainFrame:FindFirstChild("FooterBackground")
    MainFrame.BackgroundColor3 = palette.main_bg
    MainFrame.BackgroundTransparency = palette.transparency
    if titleBar then titleBar.BackgroundColor3 = palette.title_bar end
    if categoryFrame then categoryFrame.BackgroundColor3 = palette.category_bg end
    if scriptFrame then scriptFrame.BackgroundColor3 = palette.script_frame_bg end
    if footerBackground then footerBackground.BackgroundColor3 = palette.title_bar end
end

-- Variáveis de controle
local HubCreated = false

local function createHub()
    if HubCreated then return MainFrameContainer end
    HubCreated = true

    local animationContainer = Instance.new("Frame")
    animationContainer.Name = "AnimationContainer"
    animationContainer.Size = UDim2.new(0, 350, 0, 280)
    animationContainer.AnchorPoint = Vector2.new(0.5, 0.5)
    animationContainer.Position = UDim2.new(0.5, 0, 0.5, 0)
    animationContainer.BackgroundTransparency = 1
    animationContainer.Parent = ScreenGui
    local uiScaler = Instance.new("UIScale")
    uiScaler.Parent = animationContainer

    local frame = Instance.new("Frame")
    frame.Name = "MainFrame"
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = COLOR_BLACK
    frame.BorderSizePixel = 0
    frame.Parent = animationContainer
    applyRoundedCorners(frame, 12)

    local hubBorder = Instance.new("UIStroke")
    hubBorder.Thickness = 2
    hubBorder.LineJoinMode = Enum.LineJoinMode.Round
    hubBorder.Parent = frame
    local hubGradient = Instance.new("UIGradient")
    hubGradient.Color = ColorSequence.new({ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 140, 0)), ColorSequenceKeypoint.new(1, Color3.fromRGB(220, 100, 0))})
    hubGradient.Rotation = 45
    hubGradient.Parent = hubBorder

    -- [RESTANTE DO UI - MESMO DO ORIGINAL, SÓ COMPACTADO] --

    -- TitleBar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, -10, 0, 40)
    titleBar.Position = UDim2.new(0, 5, 0, 5)
    titleBar.BackgroundColor3 = COLOR_TITLEBAR
    titleBar.Parent = frame
    applyRoundedCorners(titleBar, 10)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "Khalexis Hub"
    titleLabel.TextColor3 = COLOR_TEXT
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 18
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 24, 0, 24)
    closeButton.Position = UDim2.new(1, -28, 0.5, -12)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
    closeButton.BackgroundTransparency = 1
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 18
    closeButton.Text = "X"
    closeButton.Parent = titleBar
    applyRoundedCorners(closeButton, 12)
    closeButton.MouseButton1Click:Connect(function()
        closeHubWithAnimation(animationContainer)
        HubCreated = false
    end)

    -- Dragging
    local dragging = false
    local dragStart, startPos
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = animationContainer.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            animationContainer.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    -- SearchBox, CategoryFrame, ScriptFrame, Footer (mesmo do original)
    -- [AQUI VAI TODO O RESTANTE DO UI - MESMO DO ORIGINAL]

    -- CATEGORIAS E SCRIPTS
    local scriptContainer = Instance.new("Frame")
    scriptContainer.Name = "ScriptContainer"
    scriptContainer.Size = UDim2.new(1, -20, 0, 0)
    scriptContainer.Position = UDim2.new(0, 10, 0, 10)
    scriptContainer.BackgroundTransparency = 1
    scriptContainer.Parent = frame

    local layoutScript = Instance.new("UIListLayout")
    layoutScript.Padding = UDim.new(0, 6)
    layoutScript.FillDirection = Enum.FillDirection.Vertical
    layoutScript.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layoutScript.Parent = scriptContainer

    local function clearScripts()
        for _, c in pairs(scriptContainer:GetChildren()) do
            if c:IsA("GuiObject") then c:Destroy() end
        end
    end

    local function createScriptButton(name, func)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, 0, 0, 28)
        btn.BackgroundColor3 = COLOR_SCRIPT_BTN
        btn.TextColor3 = COLOR_TEXT
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 12
        btn.Text = name
        btn.Parent = scriptContainer
        applyRoundedCorners(btn, 10)
        btn.MouseButton1Click:Connect(function()
            btn.Text = "Executando..."
            btn.Active = false
            spawn(function()
                pcall(func)
                wait(3)
                closeHubWithAnimation(MainFrameContainer)
                HubCreated = false
            end)
        end)
    end

    local function displayUpdates() end -- (pode manter vazio ou preencher)

    -- === CATEGORIAS ===
    local plantaVSBrainrotScripts = {
        {Name = "GUMANBA", Func = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/gumanba/Scripts/refs/heads/main/StealaBrainrot", true))() end},
        {Name = "Vertex-peak", Func = function() loadstring(game:HttpGet('https://raw.githubusercontent.com/vertex-peak/vertex/refs/heads/main/loadstring'))() end},
        {Name = "Blessed-Hub-X", Func = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/mynamewendel-ctrl/Blessed-Hub-X-/refs/heads/main/Plants-Vs-Brainrots.lua"))() end},
        {Name = "KASPIK", Func = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/KaspikScriptsRb/steal-a-brainrot/refs/heads/main/.lua"))() end},
        {Name = "LURK NO KEY", Func = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/egor2078f/Lurkv3/refs/heads/main/main.lua", true))() end}
    }

    -- [OUTRAS CATEGORIAS AQUI - MANTIDAS DO ORIGINAL]

    -- Botão de categoria
    local function createCategoryButton(name, contents)
        local btn = Instance.new("TextButton")
        btn.Text = name
        btn.Size = UDim2.new(1, 0, 0, 22)
        btn.BackgroundColor3 = COLOR_CATEGORY_BTN
        btn.TextColor3 = Color3.fromRGB(230, 230, 230)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 9
        btn.Parent = frame -- ajuste conforme o frame de categorias
        applyRoundedCorners(btn, 8)
        btn.MouseButton1Click:Connect(function()
            clearScripts()
            for _, s in ipairs(contents) do
                createScriptButton(s.Name, s.Func)
            end
        end)
    end

    createCategoryButton("Planta Vs Brainrot Scripts", plantaVSBrainrotScripts)

    MainFrameContainer = animationContainer
    return animationContainer
end

-- === TOGGLE BUTTON "K" (CORRIGIDO) ===
ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0, 35, 0, 35)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.BackgroundColor3 = Color3.new(0, 0, 0)
ToggleButton.TextColor3 = Color3.new(1, 1, 1)
ToggleButton.Text = "K"
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 24
ToggleButton.Parent = ScreenGui
applyRoundedCorners(ToggleButton, 10)

-- Dragging do Toggle
local draggingToggle = false
local dragStartToggle, startPosToggle
ToggleButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingToggle = true
        dragStartToggle = input.Position
        startPosToggle = ToggleButton.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if draggingToggle and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStartToggle
        ToggleButton.Position = UDim2.new(startPosToggle.X.Scale, startPosToggle.X.Offset + delta.X, startPosToggle.Y.Scale, startPosToggle.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingToggle = false
    end
end)

-- === CLIQUE NO "K" (SEM DUPLICAÇÃO) ===
ToggleButton.MouseButton1Click:Connect(function()
    if HubOpen then
        if MainFrameContainer then
            closeHubWithAnimation(MainFrameContainer)
            HubCreated = false
        end
    else
        if not HubCreated then
            MainFrameContainer = createHub()
            HubOpen = true
            ToggleButton.Visible = false
        end
    end
end)

-- === VALIDAÇÃO DE KEY ===
local function validateKeyAndOpen(key, isAuto)
    local lowerKey = key:lower()
    if validKeys[lowerKey] then
        saveKeyLocally(lowerKey)
        showAutoMessage("Key verificada! Abrindo hub...")
        wait(1)
        if not HubCreated then
            MainFrameContainer = createHub()
            HubOpen = true
            ToggleButton.Visible = false
        end
        return true
    else
        removeLocalKey()
        showError("Key incorreta")
        return false
    end
end

local function tryAutoValidate()
    local savedKey = loadKeyLocally()
    if savedKey and validKeys[savedKey] then
        return validateKeyAndOpen(savedKey, true)
    else
        removeLocalKey()
        return false
    end
end

-- === KEY INPUT (se não tiver key) ===
if not tryAutoValidate() then
    KeyFrame = Instance.new("Frame")
    KeyFrame.Size = UDim2.new(0, 300, 0, 240)
    KeyFrame.Position = UDim2.new(0.5, -150, 0.5, -120)
    KeyFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    KeyFrame.Parent = ScreenGui
    applyRoundedCorners(KeyFrame, 12)

    local keyBox = Instance.new("TextBox")
    keyBox.Size = UDim2.new(1, -30, 0, 35)
    keyBox.Position = UDim2.new(0, 15, 0, 55)
    keyBox.PlaceholderText = "Cole sua key aqui"
    keyBox.Parent = KeyFrame

    local confirmBtn = Instance.new("TextButton")
    confirmBtn.Size = UDim2.new(0, 90, 0, 30)
    confirmBtn.Position = UDim2.new(0.5, -45, 0, 95)
    confirmBtn.Text = "Confirmar"
    confirmBtn.Parent = KeyFrame
    confirmBtn.MouseButton1Click:Connect(function()
        validateKeyAndOpen(keyBox.Text:gsub("%s", ""):lower(), false)
    end)
end
